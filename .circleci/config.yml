version: 2.1

jobs:
  # ---------------------------------------------------------
  # Job 1: Setup Environment and Install Dependencies
  # ---------------------------------------------------------
  build:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout

      - run:
          name: "Install UV and Add to Path"
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            uv --version

      - run:
          name: "Create Virtual Env & Install All Dependencies via UV"
          command: |
            uv venv --python 3.12
            source .venv/bin/activate
            uv sync --all-packages --extra dev --verbose

      - run:
          name: "Install Local Packages (email_api, gmail_impl, slack)"
          command: |
            source .venv/bin/activate
            echo "Installing local packages from src directory..."
            cd src
            uv pip install -e ./email_api
            uv pip install -e ./gmail_impl
            uv pip install -e ./slack_api
            uv pip install -e ./slack_impl
            uv pip install -e ./slack_service
            cd ..



      - run:
          name: "Verify Installation"
          command: |
            source .venv/bin/activate
            uv tree
            ruff --version
            pytest --version
            mypy --version

      - run:
          name: "Ensure OpenAPI Client Exists"
          command: |
            source .venv/bin/activate
            echo "Checking for clients/specs/openapi.json..."
            if [ ! -f clients/specs/openapi.json ]; then
              echo "Generating OpenAPI spec..."
              uv run python scripts/export_openapi.py
            fi
            echo "Checking for generated client..."
            if [ ! -d clients/python/mail_client_service_client ]; then
              echo "Generating Python client from spec..."
              uv run openapi-python-client generate \
                  --path clients/specs/openapi.json \
                  --output clients/python --overwrite
            fi

      - persist_to_workspace:
          root: .
          paths:
            - .

  # ---------------------------------------------------------
  # Job 2: Local Precheck (Ruff + MyPy + Unit Tests)
  # ---------------------------------------------------------
  precheck:
    docker:
      - image: cimg/python:3.12
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Run Local Precommit Checks"
          command: |
            chmod +x scripts/precheck.sh || true
            ./scripts/precheck.sh

  # ---------------------------------------------------------
  # Job 3: Linting
  # ---------------------------------------------------------
  lint:
    docker:
      - image: cimg/python:3.12
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Run Ruff Linter"
          command: |
            source .venv/bin/activate
            ruff check .

  # ---------------------------------------------------------
  # Job 4: Unit Tests + Coverage + MyPy
  # ---------------------------------------------------------
  unit_test:
    docker:
      - image: cimg/python:3.12
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Prepare for Unit Tests"
          command: |
            source .venv/bin/activate
            mkdir -p test-results/unit
      - run:
          name: "Run Unit Tests with Coverage"
          command: |
            source .venv/bin/activate
            pytest src/ --cov=src --cov-report=xml --cov-report=term \
                   --junitxml=test-results/unit/junit.xml \
                   --cov-fail-under=85
      - run:
          name: "Run Static Type Checks (mypy)"
          command: |
            source .venv/bin/activate
            uv add types-requests
            uv run mypy --config-file mypy.ini \
              -p email_api \
              -p gmail_impl \
              -p mail_client_adapter \
              -p mail_client_service \
              -p slack_api \
              -p slack_impl \
              -p slack_service
      - store_test_results:
          path: test-results/unit
      - store_artifacts:
          path: coverage.xml
      - store_artifacts:
          path: test-results/unit

  # ---------------------------------------------------------
  # Job 5: CircleCI Non-Local Tests
  # ---------------------------------------------------------
  circleci_test:
    docker:
      - image: cimg/python:3.12
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Prepare for CircleCI Tests"
          command: |
            source .venv/bin/activate
            mkdir -p test-results/circleci
      - run:
          name: "Run All Non-local Tests"
          command: |
            source .venv/bin/activate
            pytest src/ tests/ -m "not local_credentials" \
                   --junitxml=test-results/circleci/junit.xml -v \
                   --cov=src --cov-report=term
      - store_test_results:
          path: test-results/circleci
      - store_artifacts:
          path: test-results/circleci

  # ---------------------------------------------------------
  # Job 6: Integration Tests with Real Gmail API
  # ---------------------------------------------------------
  integration_test:
    docker:
      - image: cimg/python:3.12
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Check Environment Variables"
          command: |
            if [ -z "$GMAIL_CLIENT_ID" ] || [ -z "$GMAIL_CLIENT_SECRET" ] || [ -z "$GMAIL_REFRESH_TOKEN" ]; then
              echo "⚠️ Missing Gmail API credentials. Integration tests may be skipped."
            else
              echo "✅ All Gmail API credentials are present."
            fi
      - run:
          name: "Run Integration Tests (Real Gmail API)"
          command: |
            source .venv/bin/activate
            mkdir -p test-results/integration
            pytest -m "integration and not local_credentials" \
                   --junitxml=test-results/integration/junit.xml -v \
                   --no-cov
      - store_test_results:
          path: test-results/integration
      - store_artifacts:
          path: test-results/integration

  # ---------------------------------------------------------
  # Job 7: Summary Report
  # ---------------------------------------------------------
  report_summary:
    docker:
      - image: cimg/base:stable
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Report Results"
          command: |
            echo "---- Unit Tests ----"
            [ -f test-results/unit/junit.xml ] && echo "✅ Unit results found." || echo "❌ Missing unit results."
            echo "---- CircleCI Tests ----"
            [ -f test-results/circleci/junit.xml ] && echo "✅ CircleCI results found." || echo "❌ Missing CircleCI results."
            echo "---- Integration Tests ----"
            [ -f test-results/integration/junit.xml ] && echo "✅ Integration results found." || echo "ℹ️ Integration skipped."
            echo "---- Coverage ----"
            [ -f coverage.xml ] && echo "Coverage file found." || echo "No coverage.xml."

# ---------------------------------------------------------
# Workflows
# ---------------------------------------------------------
workflows:
  build_and_test:
    jobs:
      - build:
          filters:
            branches:
              ignore:
                - main
                - develop
                - kamen-requierd-fixes
      - precheck:
          requires: [build]
          filters:
            branches:
              ignore:
                - main
                - develop
                - kamen-requierd-fixes
      - lint:
          requires: [precheck]
          filters:
            branches:
              ignore:
                - main
                - develop
                - kamen-requierd-fixes
      - unit_test:
          requires: [build]
          filters:
            branches:
              ignore:
                - main
                - develop
                - kamen-requierd-fixes
      - circleci_test:
          requires: [unit_test]
          filters:
            branches:
              ignore:
                - main
                - develop
                - kamen-requierd-fixes
      - report_summary:
          requires: [unit_test, circleci_test]
          filters:
            branches:
              ignore:
                - main
                - develop
                - kamen-requierd-fixes

  full_integration:
    jobs:
      - build:
          filters:
            branches:
              only:
                - main
                - develop
                - kamen-requierd-fixes
                - hw2   # for debug
      - lint:
          requires: [build]
          filters:
            branches:
              only:
                - main
                - develop
                - kamen-requierd-fixes
                - hw2
      - unit_test:
          requires: [build]
          filters:
            branches:
              only:
                - main
                - develop
                - kamen-requierd-fixes
                - hw2
      - circleci_test:
          requires: [unit_test]
          filters:
            branches:
              only:
                - main
                - develop
                - kamen-requierd-fixes
                - hw2
      - integration_test:
          requires: [circleci_test]
          context: gmail-client
          filters:
            branches:
              only:
                - main
                - develop
                - kamen-requierd-fixes
                - hw2
      - report_summary:
          requires: [unit_test, circleci_test, integration_test]
          filters:
            branches:
              only:
                - main
                - develop
                - kamen-requierd-fixes
                - hw2
