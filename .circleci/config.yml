version: 2.1

executors:
  py312:
    docker:
      - image: cimg/python:3.12

commands:
  install_uv:
    steps:
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            uv --version

  restore_uv_cache:
    steps:
      - restore_cache:
          keys:
            - v2-uv-cache-{{ checksum "pyproject.toml" }}-{{ checksum "uv.lock" }}

  save_uv_cache:
    steps:
      - save_cache:
          key: v2-uv-cache-{{ checksum "pyproject.toml" }}-{{ checksum "uv.lock" }}
          paths:
            - ~/.cache/uv

  setup_workspace:
    steps:
      - checkout
      - install_uv
      - run:
          name: Sync workspace (dev + all packages)
          command: |
            uv sync --all-packages --dev
      - run:
          name: Activate venv
          command: |
            echo 'source .venv/bin/activate' >> $BASH_ENV
            source $BASH_ENV

jobs:
  bootstrap_env:
    executor: py312
    steps:
      - setup_workspace
      - restore_uv_cache
      - run: python --version
      - run: uv --version
      - save_uv_cache

  ruff_lint:
    executor: py312
    steps:
      - setup_workspace
      - run:
          name: Ruff lint
          command: uv run ruff check .

  mypy_strict_checks:
    executor: py312
    steps:
      - setup_workspace
      - run:
          name: MyPy strict
          command: uv run mypy --config-file mypy.ini

  unit_tests_pytest:
    executor: py312
    steps:
      - setup_workspace
      - run:
          name: Run unit/integration tests
          command: |
            mkdir -p test-results
            uv run pytest -q --cov=src --cov-report=xml --junitxml=test-results/junit.xml
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage.xml

  coverage_enforce_85:
    executor: py312
    steps:
      - setup_workspace
      - run:
          name: Enforce coverage ≥ 85%
          command: |
            uv run pytest -q --cov=src --cov-fail-under=85

  package_import_smoke:
    executor: py312
    steps:
      - setup_workspace
      - run:
          name: Import smoke test for packages
          command: |
            python - <<'PY'
            import importlib, pathlib
            roots = [pathlib.Path('src')]
            mods = []
            for root in roots:
                for pkg in root.iterdir():
                    inner = pkg / 'src'
                    if inner.is_dir():
                        for mod_dir in inner.iterdir():
                            if mod_dir.is_dir() and (mod_dir / '__init__.py').exists():
                                mods.append(mod_dir.name)
            print("Discovered packages:", mods)
            failed = []
            for m in mods:
                try:
                    importlib.import_module(m)
                except Exception as e:
                    failed.append((m, repr(e)))
            if failed:
                for m, e in failed:
                    print(f"FAILED IMPORT: {m}: {e}")
                raise SystemExit(1)
            PY

  report_summary:
    executor: py312
    steps:
      - setup_workspace
      - run:
          name: Report environment and summaries
          command: |
            python -V
            uv --version
            echo "Workspace ready. Reports uploaded in previous jobs."

  deploy_render:
    executor: py312
    steps:
      - checkout
      - run:
          name: Trigger Render auto-deploy (no-op if auto deploy is on push)
          command: echo "Render is configured to auto-deploy on push to this branch."

  deploy_health_check_200:
    executor: py312
    environment:
      RENDER_HEALTH_URL: "https://ospsd-hw2-final-demo.onrender.com/health"
    steps:
      - checkout
      - run:
          name: Health check /health returns 200 with retries
          command: |
            chmod +x scripts/ci/health_check.sh || true
            if [ ! -f scripts/ci/health_check.sh ]; then
              echo "health_check.sh not found; creating a temporary one as fallback"
              mkdir -p scripts/ci
              cat > scripts/ci/health_check.sh <<'SH'
              #!/usr/bin/env bash
              set -euo pipefail
              URL="${RENDER_HEALTH_URL:-https://ospsd-hw2-final-demo.onrender.com/health}"
              MAX_ATTEMPTS="${MAX_ATTEMPTS:-12}"
              SLEEP_SECS="${SLEEP_SECS:-5}"
              CONNECT_TIMEOUT="${CONNECT_TIMEOUT:-10}"
              READ_TIMEOUT="${READ_TIMEOUT:-10}"
              echo "Checking: $URL"
              for i in $(seq 1 "$MAX_ATTEMPTS"); do
                CODE="$(curl -sS -o /dev/null -w "%{http_code}"                   --connect-timeout "$CONNECT_TIMEOUT"                   --max-time "$READ_TIMEOUT"                   "$URL" || echo "000")"
                if [[ "$CODE" == "200" ]]; then
                  echo "HTTP 200 OK from $URL"
                  curl -sS "$URL" || true
                  exit 0
                fi
                echo "Attempt $i/$MAX_ATTEMPTS → got $CODE; sleeping ${SLEEP_SECS}s…"
                sleep "$SLEEP_SECS"
              done
              echo "Health check FAILED after $MAX_ATTEMPTS attempts."
              exit 1
              SH
              chmod +x scripts/ci/health_check.sh
            fi
            scripts/ci/health_check.sh

workflows:
  hw2_pipeline:
    jobs:
      - bootstrap_env
      - ruff_lint:
          requires: [bootstrap_env]
      - mypy_strict_checks:
          requires: [bootstrap_env]
      - unit_tests_pytest:
          requires: [ruff_lint, mypy_strict_checks]
      - coverage_enforce_85:
          requires: [unit_tests_pytest]
      - package_import_smoke:
          requires: [unit_tests_pytest]
      - report_summary:
          requires: [coverage_enforce_85, package_import_smoke]
      - deploy_render:
          requires: [report_summary]
      - deploy_health_check_200:
          requires: [deploy_render]
          filters:
            branches:
              only:
                - main
                - hw2
                - feature/slack-client-and-ci-raunak