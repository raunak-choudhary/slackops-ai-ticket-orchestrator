version: 2.1

executors:
  py312:
    docker:
      - image: cimg/python:3.12

commands:
  restore_uv_cache:
    steps:
      - restore_cache:
          key: v1-uv-cache-{{ checksum "pyproject.toml" }}-{{ checksum "uv.lock" }}

  save_uv_cache:
    steps:
      - save_cache:
          key: v1-uv-cache-{{ checksum "pyproject.toml" }}-{{ checksum "uv.lock" }}
          paths:
            - ~/.cache/pip
            - .venv

jobs:
  bootstrap_env:
    executor: py312
    steps:
      - checkout
      - run: python -V && pip -V
      - run:
          name: Install uv
          command: |
            pip install --upgrade pip
            pip install uv
      - restore_uv_cache
      - run:
          name: uv sync
          command: uv sync --all-packages --dev
      - save_uv_cache
      - persist_to_workspace:
          root: .
          paths:
            - .

  ruff_lint:
    executor: py312
    steps:
      - attach_workspace: { at: . }
      - run:
          name: uv run ruff check
          command: uv run ruff check .

  mypy_strict_checks:
    executor: py312
    steps:
      - attach_workspace: { at: . }
      - run:
          name: uv run mypy (strict)
          command: >
            uv run mypy
            -p email_api -p gmail_impl -p mail_client_service -p mail_client_adapter
            -p slack_api -p slack_impl -p slack_service -p slack_adapter
            tests

  unit_tests_pytest:
    executor: py312
    steps:
      - attach_workspace: { at: . }
      - run:
          name: Ensure test-results dir
          command: mkdir -p test-results
      - run:
          name: uv run pytest with coverage
          command: >
            uv run pytest -q
            --cov=src --cov-report=xml
            --junitxml=test-results/junit.xml
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage.xml

  coverage_enforce_85:
    executor: py312
    steps:
      - attach_workspace: { at: . }
      - run:
          name: Enforce 85% coverage
          command: |
            python - << 'PY'
            import xml.etree.ElementTree as ET
            p = ET.parse('coverage.xml')
            cov = float(p.getroot().attrib['line-rate']) * 100
            print(f"Total coverage: {cov:.2f}%")
            assert cov >= 85, f"Coverage failure: total of {cov:.0f} is less than fail-under=85"
            PY

  package_import_smoke:
    executor: py312
    steps:
      - attach_workspace: { at: . }
      - run:
          name: Import smoke
          command: >
            uv run python -c "import email_api, gmail_impl, mail_client_service, mail_client_adapter,
            slack_api, slack_impl, slack_service, slack_adapter; print('imports OK')"

  report_summary:
    executor: py312
    steps:
      - attach_workspace: { at: . }
      - run:
          name: Summary
          command: |
            echo "âœ… Ruff, MyPy, Tests, Coverage, and Imports all passed."

  deploy_health_check_200:
    executor: py312
    steps:
      - attach_workspace: { at: . }
      - run:
          name: Deploy (Render) via uvicorn (example) or skip if external CI handles deploy
          command: echo "Deploy step handled by Render auto-deploy on push."
      - run:
          name: Health check /health
          command: |
            python - << 'PY'
            import os, urllib.request, sys
            url = os.getenv('SERVICE_HEALTH_URL', 'https://ospsd-hw2-final-demo.onrender.com/health')
            try:
              with urllib.request.urlopen(url, timeout=20) as r:
                code = r.getcode()
                print("Health:", code)
                sys.exit(0 if code == 200 else 1)
            except Exception as e:
              print("Health check failed:", e)
              sys.exit(1)
            PY

workflows:
  hw2_pipeline:
    jobs:
      - bootstrap_env
      - ruff_lint:
          requires: [bootstrap_env]
      - mypy_strict_checks:
          requires: [bootstrap_env]
      - unit_tests_pytest:
          requires: [bootstrap_env]
      - coverage_enforce_85:
          requires: [unit_tests_pytest]
      - package_import_smoke:
          requires: [bootstrap_env]
      - report_summary:
          requires:
            - ruff_lint
            - mypy_strict_checks
            - unit_tests_pytest
            - coverage_enforce_85
            - package_import_smoke
      - deploy_health_check_200:
          requires: [report_summary]
          filters:
            branches:
              only:
                - main
                - feature/slack-client-and-ci-raunak