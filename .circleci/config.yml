version: 2.1

jobs:
  lint:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
      - restore_cache:
          keys:
            - v1-lint-deps-{{ checksum "uv.lock" }}
            - v1-lint-deps-
      - run:
          name: Install dependencies
          command: |
            source $BASH_ENV
            uv sync --extra dev --extra email --extra gmail
      - save_cache:
          paths:
            - .venv
            - ~/.cache/uv
          key: v1-lint-deps-{{ checksum "uv.lock" }}
      - run:
          name: Run ruff
          command: |
            source $BASH_ENV
            uv run ruff check .
      - run:
          name: Run mypy
          command: |
            source $BASH_ENV
            uv run mypy src/

  test-unit:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
      - restore_cache:
          keys:
            - v1-test-deps-{{ checksum "uv.lock" }}
            - v1-test-deps-
      - run:
          name: Install dependencies
          command: |
            source $BASH_ENV
            uv sync --extra dev --extra email --extra gmail
      - save_cache:
          paths:
            - .venv
            - ~/.cache/uv
          key: v1-test-deps-{{ checksum "uv.lock" }}
      - run:
          name: Run unit tests (verbose)
          command: |
            source $BASH_ENV
            mkdir -p test-results
            # Continue even if tests fail
            uv run pytest -v src/email_api/tests/ src/gmail_impl/tests/ \
              --cov=src/email_api/src/email_api \
              --cov=src/gmail_impl/src/gmail_impl \
              --cov-report=term-missing \
              --cov-report=html \
              --cov-fail-under=80 \
              --junit-xml=test-results/junit.xml \
              --disable-warnings --tb=short || true
      - run:
          name: Show pytest summary
          command: |
            echo "==================== PYTEST SUMMARY ===================="
            if [ -f test-results/junit.xml ]; then
              grep "<testcase" test-results/junit.xml | wc -l | xargs echo "Total tests run:"
              grep "<failure" test-results/junit.xml | wc -l | xargs echo "Failures:"
              grep "<skipped" test-results/junit.xml | wc -l | xargs echo "Skipped:"
              echo "========================================================"
            else
              echo "⚠️  No junit.xml found — pytest may have exited early."
            fi
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: htmlcov
          destination: coverage-report
      - store_artifacts:
          path: test-results
          destination: test-results

  test-integration:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
      - restore_cache:
          keys:
            - v1-integration-deps-{{ checksum "uv.lock" }}
            - v1-integration-deps-
      - run:
          name: Install dependencies
          command: |
            source $BASH_ENV
            uv sync --extra dev --extra email --extra gmail
      - save_cache:
          paths:
            - .venv
            - ~/.cache/uv
          key: v1-integration-deps-{{ checksum "uv.lock" }}
      - run:
          name: Setup Gmail credentials
          command: |
            echo "$GMAIL_CREDENTIALS_JSON" > credentials.json
            if [ ! -z "$GMAIL_CI_TOKEN_JSON" ]; then
              echo "$GMAIL_CI_TOKEN_JSON" > ci_token.json
            fi
      - run:
          name: Run integration tests (verbose)
          command: |
            source $BASH_ENV
            mkdir -p test-results
            export GMAIL_TOKEN_FILE=${GMAIL_CI_TOKEN_JSON:+ci_token.json}
            export GMAIL_TOKEN_FILE=${GMAIL_TOKEN_FILE:-test_token.json}
            uv run pytest tests/integration/ \
              --junit-xml=test-results/integration-junit.xml \
              -v --disable-warnings --tb=short || true
      - run:
          name: Show pytest summary
          command: |
            echo "==================== PYTEST SUMMARY ===================="
            if [ -f test-results/integration-junit.xml ]; then
              grep "<testcase" test-results/integration-junit.xml | wc -l | xargs echo "Total tests run:"
              grep "<failure" test-results/integration-junit.xml | wc -l | xargs echo "Failures:"
              grep "<skipped" test-results/integration-junit.xml | wc -l | xargs echo "Skipped:"
              echo "========================================================"
            else
              echo "⚠️  No junit.xml found — pytest may have exited early."
            fi
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: integration-test-results

  test-e2e:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
      - restore_cache:
          keys:
            - v1-e2e-deps-{{ checksum "uv.lock" }}
            - v1-e2e-deps-
      - run:
          name: Install dependencies
          command: |
            source $BASH_ENV
            uv sync --extra dev --extra email --extra gmail
      - save_cache:
          paths:
            - .venv
            - ~/.cache/uv
          key: v1-e2e-deps-{{ checksum "uv.lock" }}
      - run:
          name: Setup Gmail credentials
          command: |
            echo "$GMAIL_CREDENTIALS_JSON" > credentials.json
            if [ ! -z "$GMAIL_CI_TOKEN_JSON" ]; then
              echo "$GMAIL_CI_TOKEN_JSON" > token.json
            fi
      - run:
          name: Run E2E tests (verbose)
          command: |
            source $BASH_ENV
            mkdir -p test-results
            uv run pytest tests/e2e/ \
              --junit-xml=test-results/e2e-junit.xml \
              -v --disable-warnings --tb=short || true
      - run:
          name: Show pytest summary
          command: |
            echo "==================== PYTEST SUMMARY ===================="
            if [ -f test-results/e2e-junit.xml ]; then
              grep "<testcase" test-results/e2e-junit.xml | wc -l | xargs echo "Total tests run:"
              grep "<failure" test-results/e2e-junit.xml | wc -l | xargs echo "Failures:"
              grep "<skipped" test-results/e2e-junit.xml | wc -l | xargs echo "Skipped:"
              echo "========================================================"
            else
              echo "⚠️  No junit.xml found — pytest may have exited early."
            fi
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: e2e-test-results

workflows:
  version: 2
  full-test-suite:
    jobs:
      - lint
      - test-unit:
          requires:
            - lint
      - test-integration:
          requires:
            - test-unit
          filters:
            branches:
              only:
                - main
                - develop
                - /feature\/.*integration.*/
                - /feat\/.*gmail.*/
      - test-e2e:
          requires:
            - test-integration
          filters:
            branches:
              only:
                - main
                - /feature\/.*e2e.*/
                - /feat\/.*gmail.*/
  pr-check:
    jobs:
      - lint:
          filters:
            branches:
              ignore:
                - main
                - develop
                - /feature\/.*integration.*/
                - /feature\/.*e2e.*/
      - test-unit:
          requires:
            - lint
          filters:
            branches:
              ignore:
                - main
                - develop
                - /feature\/.*integration.*/
                - /feature\/.*e2e.*/
