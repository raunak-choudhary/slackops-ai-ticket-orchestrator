version: 2.1

executors:
  py312:
    docker:
      - image: cimg/python:3.12.5

commands:
  setup-env:
    steps:
      - run:
          name: Init shell env
          command: |
            set -e
            touch "$BASH_ENV"
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$BASH_ENV"
            source "$BASH_ENV"

  install-uv:
    steps:
      - run:
          name: Install uv
          command: |
            set -e
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$BASH_ENV"
            source "$BASH_ENV"
      - restore_cache:
          keys:
            - v1-uv-cache-{{ arch }}-{{ checksum "uv.lock" }}
            - v1-uv-cache-{{ arch }}

  sync-and-editables:
    steps:
      - run:
          name: Sync env + install all 8 packages (HW1 + HW2)
          command: |
            set -e
            source "$BASH_ENV"
            rm -rf .venv
            uv sync --all-packages --dev
            # HW1 scope
            uv pip install -e src/email_api
            uv pip install -e src/gmail_impl
            uv pip install -e src/mail_client_service
            uv pip install -e src/mail_client_adapter
            # HW2 scope
            uv pip install -e src/slack_api
            uv pip install -e src/slack_impl
            uv pip install -e src/slack_service
            uv pip install -e src/slack_adapter

jobs:
  precheck:
    executor: py312
    steps:
      - checkout
      - setup-env
      - install-uv
      - run:
          name: Sanity (python + uv)
          command: |
            set -e
            source "$BASH_ENV"
            python --version
            uv --version
      - sync-and-editables
      - run:
          name: Dry-run list installed
          command: |
            set -e
            source "$BASH_ENV"
            uv pip list

  ruff_lint:
    executor: py312
    steps:
      - checkout
      - setup-env
      - install-uv
      - sync-and-editables
      - run:
          name: Ruff Lint
          command: |
            set -e
            source "$BASH_ENV"
            uv run ruff check .

  mypy_strict_checks:
    executor: py312
    steps:
      - checkout
      - setup-env
      - install-uv
      - sync-and-editables
      - run:
          name: Ensure mypy + run strict type checks
          command: |
            set -e
            source "$BASH_ENV"
            uv pip install mypy
            uv run python -m mypy \
              -p email_api \
              -p gmail_impl \
              -p mail_client_service \
              -p mail_client_adapter \
              -p slack_api \
              -p slack_impl \
              -p slack_service \
              -p slack_adapter
            uv run python -m mypy tests

  unit_test:
    executor: py312
    steps:
      - checkout
      - setup-env
      - install-uv
      - sync-and-editables
      - run:
          name: Pytest (unit-focused, fast)
          command: |
            set -e
            source "$BASH_ENV"
            uv run pytest -q src

  coverage_test:
    executor: py312
    steps:
      - checkout
      - setup-env
      - install-uv
      - sync-and-editables
      - run:
          name: Pytest with coverage gate (≥85%)
          command: |
            set -e
            source "$BASH_ENV"
            mkdir -p test-results
            uv run pytest --cov=src \
              --cov-report=xml:coverage.xml \
              --junitxml=test-results/junit.xml \
              --cov-fail-under=85
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage.xml
      - save_cache:
          key: v1-uv-cache-{{ arch }}-{{ checksum "uv.lock" }}
          paths:
            - ~/.cache/uv

  circleci_test:
    executor: py312
    steps:
      - checkout
      - setup-env
      - install-uv
      - sync-and-editables
      - run:
          name: Repo-level smoke (imports)
          command: |
            set -e
            source "$BASH_ENV"
            uv run python - <<'PY'
import importlib, sys
mods = [
  "email_api",
  "gmail_impl",
  "mail_client_service",
  "mail_client_adapter",
  "slack_api",
  "slack_impl",
  "slack_service",
  "slack_adapter",
]
failed = []
for m in mods:
    try:
        importlib.import_module(m)
    except Exception as e:
        failed.append((m, repr(e)))
if failed:
    for m, err in failed:
        print(f"[IMPORT FAIL] {m}: {err}", file=sys.stderr)
    sys.exit(1)
print("All package imports OK.")
PY

  report_summary:
    executor: py312
    steps:
      - checkout
      - run:
          name: Summary
          command: |
            echo "---- CI Summary ----"
            echo "✅ precheck (uv + python ok)"
            echo "✅ ruff_lint"
            echo "✅ mypy_strict_checks"
            echo "✅ unit_test"
            echo "✅ coverage_test (gate ≥85%)"
            echo "✅ circleci_test (imports)"
            echo "All good for HW1 + HW2."

workflows:
  hw2_pipeline:
    jobs:
      - precheck
      - ruff_lint:
          requires: [precheck]
      - mypy_strict_checks:
          requires: [ruff_lint]
      - unit_test:
          requires: [mypy_strict_checks]
      - coverage_test:
          requires: [unit_test]
      - circleci_test:
          requires: [coverage_test]
      - report_summary:
          requires: [circleci_test]