version: 2.1

executors:
  py312:
    docker:
      - image: cimg/python:3.12

commands:
  restore_uv_cache:
    steps:
      - restore_cache:
          key: v1-uv-cache-{{ checksum "pyproject.toml" }}-{{ checksum "uv.lock" }}

  save_uv_cache:
    steps:
      - save_cache:
          key: v1-uv-cache-{{ checksum "pyproject.toml" }}-{{ checksum "uv.lock" }}
          paths:
            - ~/.cache/uv
            - .venv

jobs:
  bootstrap_env:
    executor: py312
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            uv --version
      - restore_uv_cache
      - run:
          name: Sync dependencies (all + dev)
          command: |
            source $BASH_ENV
            uv sync --all-packages --dev
      - save_uv_cache
      - persist_to_workspace:
          root: .
          paths:
            - .
            - .venv

  ruff_lint:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Ruff lint
          command: |
            source $BASH_ENV || true
            uv run ruff version
            uv run ruff check .

  mypy_strict_checks:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - run:
          name: MyPy (strict, config-driven)
          command: |
            source $BASH_ENV || true
            uv run mypy --config-file mypy.ini

  unit_tests_pytest:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run tests with coverage + JUnit
          command: |
            mkdir -p test-results
            source $BASH_ENV || true
            uv run pytest -q --cov=src --cov-report=xml --junitxml=test-results/junit.xml
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage.xml

  coverage_enforce_85:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Enforce 85% coverage
          command: |
            python - \<< 'PY'
            import xml.etree.ElementTree as ET
            p = ET.parse('coverage.xml')
            cov = float(p.getroot().attrib.get('line-rate', '0')) * 100
            print(f"Total coverage: {cov:.2f}%")
            assert cov >= 85, f"Coverage failure: total of {cov:.0f} is less than fail-under=85"
            PY

  package_import_smoke:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Import smoke (top-level packages)
          command: |
            source $BASH_ENV || true
            uv run python -c "import importlib, sys; mods=['slack_service','slack_adapter','slack_api','slack_impl','mail_client_service','mail_client_adapter','mail_client_api','gmail_impl']; 
print('Importing:', mods); 
[importlib.import_module(m) for m in mods if m]; 
print('OK')"

  report_summary:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Summarize results (Ruff / MyPy / Pytest / Coverage)
          command: |
            set -e
            echo "===== SUMMARY ====="
            echo "• Ruff: ran in job ruff_lint"
            echo "• MyPy: ran with mypy.ini in job mypy_strict_checks"
            echo "• Pytests: junit -> test-results/junit.xml"
            echo "• Coverage: coverage.xml (gate at 85%)"
            echo "• Imports: package_import_smoke"
            echo "==================="

  deploy_health_check_200:
    executor: py312
    environment:
      # Set/override in Project Settings → Environment Variables if needed
      SERVICE_HEALTH_URL: "https://ospsd-hw2-final-demo.onrender.com/health"
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Health check /health returns 200
          command: |
            python - \<< 'PY'
            import os, urllib.request, sys
            url = os.getenv('SERVICE_HEALTH_URL')
            print('Checking:', url)
            try:
              with urllib.request.urlopen(url, timeout=25) as r:
                code = r.getcode()
                print('Health:', code)
                sys.exit(0 if code == 200 else 1)
            except Exception as e:
              print('Health check failed:', e)
              sys.exit(1)
            PY

workflows:
  hw2_pipeline:
    jobs:
      - bootstrap_env
      - ruff_lint:
          requires:
            - bootstrap_env
      - mypy_strict_checks:
          requires:
            - bootstrap_env
      - unit_tests_pytest:
          requires:
            - bootstrap_env
      - coverage_enforce_85:
          requires:
            - unit_tests_pytest
      - package_import_smoke:
          requires:
            - bootstrap_env
      - report_summary:
          requires:
            - ruff_lint
            - mypy_strict_checks
            - unit_tests_pytest
            - coverage_enforce_85
            - package_import_smoke
      - deploy_health_check_200:
          requires:
            - report_summary
          filters:
            branches:
              only:
                - main
                - feature/slack-client-and-ci-raunak
                - hw2
