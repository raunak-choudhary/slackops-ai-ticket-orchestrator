version: 2.1

executors:
  py312:
    docker:
      - image: cimg/python:3.12.5

commands:
  setup-env:
    steps:
      - run:
          name: Setup Environment
          command: |
            touch "$BASH_ENV"
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$BASH_ENV"
            source "$BASH_ENV"

  install-uv:
    steps:
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$BASH_ENV"
            source "$BASH_ENV"
      - restore_cache:
          keys:
            - v1-uv-cache-{{ arch }}-{{ checksum "uv.lock" }}
            - v1-uv-cache-{{ arch }}

  sync-and-editables:
    steps:
      - run:
          name: Sync env + editable installs
          command: |
            source "$BASH_ENV"
            uv sync --all-packages --dev
            # HW1 scope
            uv pip install -e src/email_api
            uv pip install -e src/gmail_impl
            uv pip install -e src/mail_client_service
            uv pip install -e src/mail_client_adapter
            # HW2 scope
            uv pip install -e src/slack_api
            uv pip install -e src/slack_impl
            uv pip install -e src/slack_service
            uv pip install -e src/slack_adapter

jobs:
  build:
    executor: py312
    steps:
      - checkout
      - setup-env
      - install-uv
      - sync-and-editables
      - persist_to_workspace:
          root: .
          paths:
            - .

  lint:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - setup-env
      - install-uv
      - run:
          name: Ruff Linter
          command: |
            source "$BASH_ENV"
            uv run ruff check .

  typecheck:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - setup-env
      - install-uv
      - run:
          name: MyPy Strict
          command: |
            source "$BASH_ENV"
            uv run mypy \
              -p email_api \
              -p gmail_impl \
              -p mail_client_service \
              -p mail_client_adapter \
              -p slack_api \
              -p slack_impl \
              -p slack_service \
              -p slack_adapter \
              tests

  test:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - setup-env
      - install-uv
      - run:
          name: Pytest + Coverage Gate
          command: |
            source "$BASH_ENV"
            mkdir -p test-results
            uv run pytest --cov=src --cov-report=xml:coverage.xml \
              --junitxml=test-results/junit.xml --cov-fail-under=85
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage.xml

  report_summary:
    executor: py312
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Summary
          command: |
            echo "---- CI Summary ----"
            echo "✅ Ruff check passed"
            echo "✅ MyPy passed"
            echo "✅ Tests and coverage ≥85%"

workflows:
  hw2_pipeline:
    jobs:
      - build
      - lint:
          requires: [build]
      - typecheck:
          requires: [lint]
      - test:
          requires: [typecheck]
      - report_summary:
          requires: [test]
