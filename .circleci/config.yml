version: 2.1

jobs:
  quality-and-tests:
    docker:
      - image: cimg/python:3.12

    steps:
      - checkout

      - run:
          name: Install uv
          shell: /bin/bash -eo pipefail
          command: |
            python -m pip install --upgrade pip
            pip install uv
            uv --version

      - run:
          name: Install dependencies
          shell: /bin/bash -eo pipefail
          command: |
            uv sync --all-packages --dev

      - run:
          name: Validate required environment variables
          shell: /bin/bash -eo pipefail
          command: |
            required_vars=(
              SLACK_BOT_TOKEN
              SLACK_SIGNING_SECRET
              SLACK_API_BASE_URL
              SLACK_SERVICE_BASE_URL
              SLACK_TEST_CHANNEL_ID
              JIRA_API_TOKEN
              JIRA_BASE_URL
              JIRA_EMAIL
              JIRA_PROJECT_KEY
              JIRA_SERVICE_BASE_URL
              OPENAI_API_KEY
              GEMINI_API_KEY
              GEMINI_MODEL
              AI_SERVICE_BASE_URL
            )

            for var in "${required_vars[@]}"; do
              if [ -z "${!var}" ]; then
                echo "ERROR: Required environment variable $var is not set"
                exit 1
              fi
            done

            echo "All required environment variables are set"

      - run:
          name: Lint (Ruff)
          shell: /bin/bash -eo pipefail
          command: |
            uv run ruff check .

      - run:
          name: Static typing (MyPy - strict)
          shell: /bin/bash -eo pipefail
          command: |
            uv run mypy --config-file mypy.ini

      - run:
          name: Tests (CI-safe: exclude live and e2e tests)
          command: |
            uv run pytest -m "not e2e and not live" \
              --cov=src \
              --cov-report=term-missing

workflows:
  version: 2
  quality-gates:
    jobs:
      - quality-and-tests
